{
    "variables": {},
    "builders": [
        {
            "type": "azure-arm",

            "client_id": "16189da4-0cf2-4992-a268-1a2f9f5c0f25",
            "client_secret": "87m8Q~fIXvvez7PKi9ZFnoouUaYLC.l_IjPw1bgW",
            "tenant_id": "72f988bf-86f1-41af-91ab-2d7cd011db47",
            "subscription_id": "9f60f07e-8fa0-4954-8cf2-73922174d77d",

            "managed_image_resource_group_name": "packer-rg",
            "managed_image_name": "windows_image",

            "os_type": "Windows",
            "image_publisher": "microsoftwindowsserver",
            "image_offer": "windowsserver",
            "image_sku": "2022-datacenter-azure-edition-hotpatch",
            
            "communicator": "winrm",
            "winrm_use_ssl": true,
            "winrm_insecure": true,
            "winrm_timeout": "5m",
            "winrm_username": "packer",

            "azure_tags": {
                "dept": "Engineering",
                "task": "Image deployment"
            },

            "location": "East US",
            "vm_size": "Standard_DS2_v2"
        }

        
    ],
    "provisioners": [{
        "type": "powershell",
        "inline": [
          "Add-WindowsFeature Web-Server",
          "while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
          "while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
          "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
          "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
        ]
      }]
}